// VideoGen Web Application
// å®Œæ•´çš?AI è§†é¢‘ç”Ÿæˆæµç¨‹åº”ç”¨

const API_BASE_URL = 'http://localhost:8000/api'; // TODO: æ›¿æ¢ä¸ºå®é™?API åœ°å€
const API_HEALTH_URL = `${API_BASE_URL.replace(/\/api\/?$/, '')}/health`;
const API_CHECK_TIMEOUT_MS = 4000;
const API_CHECK_TTL_MS = 5000;
const API_LOGGING = true;

let apiHealthCache = {
    ok: null,
    checkedAt: 0
};

let currentStep = 1;
let maxCompletedStep = 1; // è·Ÿè¸ªç”¨æˆ·å®Œæˆçš„æœ€å¤§æ­¥éª¤æ•°
let projectId = null;
let projectData = {};

// ==================== åˆå§‹åŒ?====================
document.addEventListener('DOMContentLoaded', () => {
    projectId = 'PROJ-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase();
    document.getElementById('project-id').textContent = projectId;
    bindEvents();
    showStep(1);
    checkApiHealth(true);
});

function bindEvents() {
    // ç»‘å®šæ“ä½œæŒ‰é’®
    document.getElementById('analyze-requirement-btn').addEventListener('click', analyzeRequirement);
    document.getElementById('proceed-to-script-btn')?.addEventListener('click', () => proceedTo(2));
    document.getElementById('proceed-to-storyboard-btn')?.addEventListener('click', () => proceedTo(3));
    document.getElementById('proceed-to-images-btn')?.addEventListener('click', () => proceedTo(4));
    document.getElementById('proceed-to-video-btn')?.addEventListener('click', () => proceedTo(5));

    // ç»‘å®šå‰§æœ¬ç¼–è¾‘å’Œé‡æ–°ç”ŸæˆæŒ‰é’?
    document.getElementById('edit-script-btn')?.addEventListener('click', openScriptEditor);
    document.getElementById('regenerate-script-btn')?.addEventListener('click', regenerateScript);

    // ç»‘å®šå¯¼èˆªæ æ­¥éª¤ç‚¹å‡»äº‹ä»¶ï¼Œå…è®¸è¿”å›æŸ¥çœ‹ä¹‹å‰çš„æ­¥éª?
    document.querySelectorAll('.nav-step').forEach(step => {
        step.addEventListener('click', () => {
            const stepNum = parseInt(step.dataset.step);
            // å…è®¸åˆ‡æ¢åˆ°å·²å®Œæˆçš„ä»»ä½•æ­¥éª?
            if (stepNum <= maxCompletedStep) {
                showStep(stepNum);
            }
        });

        // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœæç¤º
        step.addEventListener('mouseenter', () => {
            const stepNum = parseInt(step.dataset.step);
            if (stepNum <= maxCompletedStep) {
                step.style.cursor = 'pointer';
            } else {
                step.style.cursor = 'not-allowed';
            }
        });
    });

    // ç»‘å®šæ¨¡æ€æ¡†çš„ESCé”®å…³é—­åŠŸèƒ?
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modal = document.getElementById('script-editor-modal');
            if (modal && modal.style.display !== 'none') {
                closeScriptEditor();
            }
        }
    });
}

function showStep(num) {
    currentStep = num;
    document.querySelectorAll('.nav-step').forEach(s => {
        const n = parseInt(s.dataset.step);
        s.classList.toggle('active', n === num);
        // æ ‡è®°ä¸ºå·²å®Œæˆï¼šæ­¥éª¤å·å°äºæœ€å¤§å®Œæˆæ­¥éª?
        s.classList.toggle('completed', n < maxCompletedStep || (n === maxCompletedStep && n < num));
    });
    document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`step-${num}`).classList.add('active');
}

function proceedTo(step) {
    // æ›´æ–°æœ€å¤§å®Œæˆæ­¥éª?
    if (step > maxCompletedStep) {
        maxCompletedStep = step;
    }
    showStep(step);
    [null, null, generateScript, generateStoryboard, generateImages, generateVideo][step]?.();
}

// ==================== API è°ƒç”¨ ====================
async function apiCall(endpoint, data) {
    try {
        const healthy = await checkApiHealth();
        if (!healthy) {
            throw new Error('åç«¯æœªå¯åŠ¨æˆ–æ— æ³•è¿æ¥ï¼Œè¯·å…ˆè¿è¡Œåç«¯æœåŠ?);
        }

        const startTime = performance.now();
        logApiEvent('request', endpoint, { payload: data });
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            logApiEvent('response', endpoint, {
                status: response.status,
                durationMs: Math.round(performance.now() - startTime)
            });
            throw new Error(`API Error: ${response.status}`);
        }

        const payload = await response.json();
        logApiEvent('response', endpoint, {
            status: response.status,
            durationMs: Math.round(performance.now() - startTime),
            data: payload
        });
        setApiStatus(true);
        return payload;
    } catch (error) {
        if (error.name === 'AbortError' || error.message.includes('Failed to fetch')) {
            setApiStatus(false);
            throw new Error('æ— æ³•è¿æ¥åç«¯æœåŠ¡ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨ä»¥å?API_BASE_URL é…ç½®');
        }
        logApiEvent('error', endpoint, { message: error.message });
        console.error('API call failed:', error);
        throw error;
    }
}

// ==================== æ­¥éª¤é€»è¾‘ ====================
async function analyzeRequirement() {
    const req = document.getElementById('user-requirement').value.trim();
    if (!req) return alert('è¯·è¾“å…¥éœ€æ±?);

    projectData.requirement = {
        description: req,
        duration: parseInt(document.getElementById('video-duration').value),
        quality_tier: document.getElementById('quality-tier').value,
        style: document.getElementById('video-style').value
    };

    showLoading('åˆ†æéœ€æ±‚ä¸­...');

    try {
        const response = await apiCall(`${API_BASE_URL}/analyze-requirement`, {
            project_id: projectId,
            requirement: projectData.requirement
        });

        // ä½¿ç”¨ API è¿”å›çš„çœŸå®æ•°æ?
        document.getElementById('analysis-theme').textContent = response.theme || 'æœªçŸ¥ä¸»é¢˜';
        document.getElementById('analysis-style').textContent = response.style || 'æœªçŸ¥é£æ ¼';
        document.getElementById('analysis-shots').textContent = `${response.shots || 0} ä¸ªé•œå¤´`;
        document.getElementById('analysis-duration').textContent = `${response.duration || 0} ç§’`;
        document.getElementById('analysis-result').style.display = 'block';

        // ä¿å­˜åˆ†æç»“æœ
        projectData.analysis = response;

        hideLoading();
    } catch (error) {
        hideLoading();
        alert('éœ€æ±‚åˆ†æå¤±è´? ' + error.message);
    }
}

async function generateScript() {
    showLoading('ç”Ÿæˆå‰§æœ¬ä¸?..');

    try {
        const response = await apiCall(`${API_BASE_URL}/generate-script`, {
            project_id: projectId,
            analysis: projectData.analysis
        });

        // ä½¿ç”¨ API è¿”å›çš„çœŸå®å‰§æœ?
        const script = response.content || 'å‰§æœ¬ç”Ÿæˆå¤±è´¥';

        document.getElementById('script-status').style.display = 'none';
        document.getElementById('script-content').textContent = script;
        document.getElementById('script-result').style.display = 'block';

        // ä¿å­˜å‰§æœ¬æ•°æ®
        projectData.script = response;

        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
        if (response.characters && response.characters.length > 0) {
            renderCharacters(response.characters);
            projectData.characters = response.characters;
        } else {
            // å¦‚æœæ²¡æœ‰è§’è‰²,æ˜¾ç¤ºæç¤º
            document.getElementById('characters-list').innerHTML = '<p class="no-characters">æ­¤å‰§æœ¬æš‚æ— è§’è‰²ä¿¡æ?/p>';
        }

        hideLoading();
    } catch (error) {
        hideLoading();
        alert('å‰§æœ¬ç”Ÿæˆå¤±è´¥: ' + error.message);
    }
}

// æ¸²æŸ“è§’è‰²åˆ—è¡¨
function renderCharacters(characters) {
    const container = document.getElementById('characters-list');
    const html = characters.map(char => `
        <div class="character-card">
            <h5 class="character-name">${char.name}</h5>
            <p class="character-desc">${char.description}</p>
        </div>
    `).join('');
    container.innerHTML = html;
}

async function generateStoryboard() {
    showLoading('ç”Ÿæˆåˆ†é•œä¸?..');

    try {
        const response = await apiCall(`${API_BASE_URL}/generate-storyboard`, {
            project_id: projectId,
            script: projectData.script
        });

        // ä½¿ç”¨ API è¿”å›çš„çœŸå®åˆ†é•œæ•°æ?
        const shots = response.shots || [];

        const html = shots.map((s, i) => `
            <div class="shot-card" data-shot="${i + 1}">
                <div class="shot-header">
                    <div class="shot-number">${i + 1}</div>
                    <div class="shot-header-info">
                        <div class="shot-title">${s.title || `é•œå¤´ ${i + 1}`}</div>
                        <div class="shot-meta">
                            <span class="meta-item"><span class="meta-icon">â±ï¸</span> ${s.duration || 0}ç§?/span>
                            <span class="meta-item"><span class="meta-icon">ğŸ“¹</span> ${s.camera || 'æœªçŸ¥'}</span>
                            <span class="meta-item"><span class="meta-icon">ğŸ¬</span> ${s.movement || 'æœªçŸ¥'}</span>
                        </div>
                    </div>
                    <button class="expand-btn" onclick="toggleShotDetails(${i + 1})">
                        <span class="expand-icon">â–?/span>
                    </button>
                </div>
                <div class="shot-body">
                    <div class="shot-section">
                        <div class="section-label">ğŸ“ åœºæ™¯æè¿°</div>
                        <div class="section-content">${s.description || 'æ— æè¿?}</div>
                    </div>
                    ${s.visual_elements ? `
                    <div class="shot-section">
                        <div class="section-label">ğŸ¨ è§†è§‰å…ƒç´ </div>
                        <div class="section-content">${s.visual_elements}</div>
                    </div>
                    ` : ''}
                    ${s.dialogue || s.narration ? `
                    <div class="shot-section">
                        <div class="section-label">ğŸ’¬ æ–‡æ¡ˆ/å¯¹ç™½</div>
                        <div class="section-content">${s.dialogue || s.narration || ''}</div>
                    </div>
                    ` : ''}
                    ${s.transition ? `
                    <div class="shot-section">
                        <div class="section-label">ğŸ”„ è½¬åœºæ•ˆæœ</div>
                        <div class="section-content">${s.transition}</div>
                    </div>
                    ` : ''}
                    ${s.notes ? `
                    <div class="shot-section">
                        <div class="section-label">ğŸ“Œ å¤‡æ³¨</div>
                        <div class="section-content shot-notes">${s.notes}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `).join('');

        document.getElementById('storyboard-status').style.display = 'none';
        document.getElementById('storyboard-list').innerHTML = html;
        document.getElementById('storyboard-result').style.display = 'block';

        // ä¿å­˜åˆ†é•œæ•°æ®
        projectData.storyboard = response;

        hideLoading();
    } catch (error) {
        hideLoading();
        alert('åˆ†é•œç”Ÿæˆå¤±è´¥: ' + error.message);
    }
}

async function generateImages() {
    const grid = document.getElementById('images-grid');
    grid.innerHTML = '';

    const totalShots = projectData.storyboard?.shots?.length || 8;

    for (let i = 1; i <= totalShots; i++) {
        grid.innerHTML += `
            <div class="image-card" id="img-${i}">
                <div class="image-preview">
                    <div class="status-icon loading">â?/div>
                </div>
                <div class="image-info">
                    <div class="image-title">é•œå¤´ ${i}</div>
                    <div class="image-status">ç”Ÿæˆä¸?..</div>
                </div>
            </div>
        `;
    }

    // é€ä¸ªç”Ÿæˆå›¾åƒ
    for (let i = 1; i <= totalShots; i++) {
        document.getElementById('images-progress-fill').style.width = `${(i / totalShots) * 100}%`;
        document.getElementById('images-progress-text').textContent = `${i} / ${totalShots} å·²å®Œæˆ`;

        try {
            // è·å–å¯¹åº”çš„åˆ†é•œä¿¡æ?
            const shots = projectData.storyboard?.shots || [];
            const shotInfo = shots[i - 1] || null; // æ•°ç»„ç´¢å¼•ä»?0 å¼€å§?

            const response = await apiCall(`${API_BASE_URL}/generate-image`, {
                project_id: projectId,
                shot: i,
                shot_info: shotInfo  // ä¼ é€’åˆ†é•œè¯¦ç»†ä¿¡æ?
            });

            const card = document.getElementById(`img-${i}`);
            const imageUrl = response.image_url || createPlaceholderSVG(i, '#6366f1');
            card.querySelector('.image-preview').innerHTML = `<img src="${imageUrl}">`;
            card.querySelector('.image-status').textContent = response.success ? 'å·²å®Œæˆ? : 'ä½¿ç”¨å ä½å›?;

            // ä¿å­˜å›¾åƒæ•°æ®ä¾›è§†é¢‘ç”Ÿæˆä½¿ç”?
            if (!projectData.images) {
                projectData.images = [];
            }
            projectData.images[i - 1] = {
                shot: i,
                image_url: imageUrl,
                success: response.success
            };
        } catch (error) {
            console.error(`Image ${i} generation failed:`, error);
            const card = document.getElementById(`img-${i}`);
            card.querySelector('.image-preview').innerHTML = `<img src="${createPlaceholderSVG(i, '#ef4444')}">`;
            card.querySelector('.image-status').textContent = 'ç”Ÿæˆå¤±è´¥';

            // ä¿å­˜å¤±è´¥çš„å›¾åƒæ•°æ?
            if (!projectData.images) {
                projectData.images = [];
            }
            projectData.images[i - 1] = {
                shot: i,
                image_url: createPlaceholderSVG(i, '#ef4444'),
                success: false
            };
        }

        await new Promise(r => setTimeout(r, 500));
    }

    document.getElementById('images-actions').style.display = 'block';
}

// åˆ›å»ºæœ¬åœ° SVG å ä½å›?
function createPlaceholderSVG(shotNumber, color = '#6366f1') {
    const svg = `
        <svg width="800" height="450" xmlns="http://www.w3.org/2000/svg">
            <rect width="800" height="450" fill="#1e293b"/>
            <text x="400" y="225" font-family="Arial, sans-serif" font-size="48" 
                  fill="${color}" text-anchor="middle" dominant-baseline="middle">
                é•œå¤´ ${shotNumber}
            </text>
        </svg>
    `;
    return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
}

async function generateVideo() {
    showLoading('ç”Ÿæˆè§†é¢‘ä¸?..');

    try {
        const shots = projectData.storyboard?.shots || [];
        const images = projectData.images || [];

        if (shots.length === 0) {
            throw new Error('æ²¡æœ‰åˆ†é•œæ•°æ®');
        }

        if (images.length === 0) {
            throw new Error('æ²¡æœ‰å‚è€ƒå›¾ï¼Œè¯·å…ˆç”Ÿæˆå›¾åƒ?);
        }

        const videoClips = [];
        const totalShots = Math.min(shots.length, images.length);

        // æ˜¾ç¤ºè¿›åº¦
        document.getElementById('video-status').style.display = 'block';
        document.getElementById('video-status').innerHTML = `
            <div class="status-text">æ­£åœ¨ç”Ÿæˆè§†é¢‘ç‰‡æ®µ...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="video-progress-fill"></div>
            </div>
            <div class="progress-text" id="video-progress-text">0 / ${totalShots} å·²å®Œæˆ?/div>
        `;

        // åˆ›å»ºè§†é¢‘ç½‘æ ¼
        const grid = document.getElementById('videos-grid');
        grid.innerHTML = '';

        for (let i = 1; i <= totalShots; i++) {
            grid.innerHTML += `
                <div class="video-card" id="video-${i}">
                    <div class="video-preview">
                        <div class="status-icon loading">â?/div>
                    </div>
                    <div class="video-info">
                        <div class="video-title">é•œå¤´ ${i}</div>
                        <div class="video-status">ç”Ÿæˆä¸?..</div>
                    </div>
                </div>
            `;
        }

        // é€ä¸ªé•œå¤´ç”Ÿæˆè§†é¢‘
        for (let i = 0; i < totalShots; i++) {
            const shot = shots[i];
            const image = images[i];

            if (!image || !image.image_url) {
                console.warn(`No image for shot ${i + 1}, skipping`);
                const card = document.getElementById(`video-${i + 1}`);
                card.querySelector('.video-preview').innerHTML = `<div class="status-icon error">â?/div>`;
                card.querySelector('.video-status').textContent = 'è·³è¿‡ï¼ˆæ— å‚è€ƒå›¾ï¼?;
                continue;
            }

            try {
                console.log(`Generating video for shot ${i + 1}...`);

                const response = await apiCall(`${API_BASE_URL}/generate-video`, {
                    project_id: projectId,
                    shot: i + 1,
                    image_url: image.image_url,
                    shot_info: shot
                });

                const card = document.getElementById(`video-${i + 1}`);

                if (response.success && response.video_url) {
                    videoClips.push({
                        shot: i + 1,
                        url: response.video_url,
                        duration: shot.duration || 4
                    });

                    // æ˜¾ç¤ºè§†é¢‘
                    card.querySelector('.video-preview').innerHTML = `
                        <video controls>
                            <source src="${response.video_url}" type="video/mp4">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                        </video>
                    `;
                    card.querySelector('.video-status').textContent = 'å·²å®Œæˆ?;
                    console.log(`Shot ${i + 1} video generated:`, response.video_url);
                } else {
                    card.querySelector('.video-preview').innerHTML = `<div class="status-icon error">â?/div>`;
                    card.querySelector('.video-status').textContent = 'ç”Ÿæˆå¤±è´¥';
                }

                // æ›´æ–°è¿›åº¦
                document.getElementById('video-progress-fill').style.width = `${((i + 1) / totalShots) * 100}%`;
                document.getElementById('video-progress-text').textContent = `${i + 1} / ${totalShots} å·²å®Œæˆ`;

            } catch (error) {
                console.error(`Video generation failed for shot ${i + 1}:`, error);
                const card = document.getElementById(`video-${i + 1}`);
                card.querySelector('.video-preview').innerHTML = `<div class="status-icon error">â?/div>`;
                card.querySelector('.video-status').textContent = 'ç”Ÿæˆå¤±è´¥';
            }

            await new Promise(r => setTimeout(r, 500));
        }

        hideLoading();

        if (videoClips.length === 0) {
            throw new Error('æ‰€æœ‰é•œå¤´çš„è§†é¢‘ç”Ÿæˆéƒ½å¤±è´¥äº†');
        }

        // ä¿å­˜è§†é¢‘ç‰‡æ®µæ•°æ®
        projectData.videoClips = videoClips;

        // æ˜¾ç¤ºç¬¬ä¸€ä¸ªè§†é¢‘ç‰‡æ®µï¼ˆæˆ–åˆå¹¶åçš„è§†é¢‘ï¼‰
        document.getElementById('video-status').style.display = 'none';
        const firstVideoUrl = videoClips[0].url;
        document.getElementById('final-video').src = firstVideoUrl;
        document.getElementById('video-result').style.display = 'block';

        // æ˜¾ç¤ºæ‰€æœ‰è§†é¢‘ç‰‡æ®µä¿¡æ?
        console.log('Generated video clips:', videoClips);
        alert(`æˆåŠŸç”Ÿæˆ ${videoClips.length} ä¸ªè§†é¢‘ç‰‡æ®µï¼\næ³¨æ„ï¼šå½“å‰æ˜¾ç¤ºç¬¬ä¸€ä¸ªç‰‡æ®µï¼Œå®Œæ•´è§†é¢‘åˆå¹¶åŠŸèƒ½å¾…å®ç°ã€‚`);

    } catch (error) {
        hideLoading();
        alert('è§†é¢‘ç”Ÿæˆå¤±è´¥: ' + error.message);
        document.getElementById('video-status').style.display = 'none';
    }
}

// ä¸‹è½½æ‰€æœ‰è§†é¢?
function downloadAllVideos() {
    const videoClips = projectData.videoClips || [];
    if (videoClips.length === 0) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„è§†é¢‘');
        return;
    }

    videoClips.forEach((clip, index) => {
        setTimeout(() => {
            const a = document.createElement('a');
            a.href = clip.url;
            a.download = `shot-${clip.shot}.mp4`;
            a.click();
        }, index * 500);
    });
}

// ==================== å·¥å…·å‡½æ•° ====================
function showLoading(text) {
    document.getElementById('loading-text').textContent = text;
    document.getElementById('loading-overlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.remove('active');
}

async function checkApiHealth(force = false) {
    const now = Date.now();
    if (!force && apiHealthCache.ok !== null && now - apiHealthCache.checkedAt < API_CHECK_TTL_MS) {
        return apiHealthCache.ok;
    }

    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), API_CHECK_TIMEOUT_MS);
    try {
        const response = await fetch(API_HEALTH_URL, { signal: controller.signal });
        apiHealthCache.ok = response.ok;
    } catch (error) {
        apiHealthCache.ok = false;
    } finally {
        clearTimeout(timer);
        apiHealthCache.checkedAt = now;
        setApiStatus(apiHealthCache.ok);
    }

    return apiHealthCache.ok;
}

function setApiStatus(ok) {
    const statusEl = document.getElementById('project-status');
    if (!statusEl) return;
    statusEl.textContent = ok ? 'åç«¯å·²è¿æ? : 'åç«¯æœªè¿æ?;
}

function logApiEvent(type, endpoint, detail) {
    if (!API_LOGGING) return;
    const time = new Date().toISOString();
    const label = `[API] ${type.toUpperCase()} ${endpoint}`;
    if (type === 'error') {
        console.error(label, time, detail);
        return;
    }
    console.log(label, time, detail);
}

// ==================== å‰§æœ¬ç¼–è¾‘åŠŸèƒ½ ====================
function openScriptEditor() {
    const scriptContent = projectData.script?.content || '';
    const modal = document.getElementById('script-editor-modal');
    const textarea = document.getElementById('script-editor-textarea');

    if (!scriptContent) {
        alert('æ²¡æœ‰å¯ç¼–è¾‘çš„å‰§æœ¬å†…å®¹');
        return;
    }

    textarea.value = scriptContent;
    modal.style.display = 'flex';
    textarea.focus();
}

function closeScriptEditor() {
    const modal = document.getElementById('script-editor-modal');
    modal.style.display = 'none';
}

async function saveScriptEdits() {
    const textarea = document.getElementById('script-editor-textarea');
    const newContent = textarea.value.trim();

    if (!newContent) {
        alert('å‰§æœ¬å†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
    }

    showLoading('ä¿å­˜å‰§æœ¬ä¸?..');

    try {
        // è°ƒç”¨åç«¯APIä¿å­˜ç¼–è¾‘åçš„å‰§æœ¬
        const response = await apiCall(`${API_BASE_URL}/update-script`, {
            project_id: projectId,
            content: newContent
        });

        if (response.success) {
            // æ›´æ–°æœ¬åœ°æ•°æ®
            projectData.script.content = newContent;

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.getElementById('script-content').textContent = newContent;

            // å…³é—­æ¨¡æ€æ¡†
            closeScriptEditor();

            hideLoading();
            alert('å‰§æœ¬ä¿å­˜æˆåŠŸï¼?);
        } else {
            throw new Error(response.message || 'ä¿å­˜å¤±è´¥');
        }
    } catch (error) {
        hideLoading();
        alert('ä¿å­˜å‰§æœ¬å¤±è´¥: ' + error.message);
    }
}

async function regenerateScript() {
    if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆå‰§æœ¬å—ï¼Ÿå½“å‰çš„å‰§æœ¬å†…å®¹å°†è¢«è¦†ç›–ã€?)) {
        return;
    }

    showLoading('é‡æ–°ç”Ÿæˆå‰§æœ¬ä¸?..');

    try {
        const response = await apiCall(`${API_BASE_URL}/generate-script`, {
