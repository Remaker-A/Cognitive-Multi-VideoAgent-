# 工程级超细化版本 v3.5（Agent 系统架构方案）

本方案为系统后端架构与 Agent RPC 交互的工程级落地方案，包含任务发布机制、白板写入规范、Agent 间时间顺序、事件生命周期、任务锁、执行流程、工单机制等核心可执行内容，技术团队可直接基于此开发。



***

## 一、系统三层架构

系统分为三层，各层职责与组件明确，通过 Shared Blackboard 实现数据交互。

### L1：Interaction 层



* **核心组件**：Requirement Parser Agent

* **运行模式**：支持 High / Balanced / Fast 三种模式

* **输入内容**：文字需求、参考图、参考音乐、参考视频

* **输出内容**：写入 Shared Blackboard，包含 globalSpec、userPreferences、modelPackage 三类核心数据

### L2：Cognitive Multi-Agent 层

负责所有脑力工作， Agents 不互相调用函数，通过 Task + Event + 白板 Blackboard 协作。



| Agent 类型   | 包含组件                                                                                        | 核心职责                           |
| ---------- | ------------------------------------------------------------------------------------------- | ------------------------------ |
| 核心认知 Agent | ChefAgent、ScriptWriter Agent、ShotDirector Agent、ArtDirector Agent、ConsistencyGuardian Agent | 写作、分镜、艺术风格定义、一致性校验、审查修复等核心决策工作 |
| 模型执行 Agent | ImageGen Agent、VideoGen Agent、VoiceActor Agent、MusicComposer Agent                          | 图像生成、视频生成、配音、音乐创作等执行类任务        |
| 基础设施 Agent | Orchestrator、Storage & Artifacts、HumanGate Agent                                            | 任务编排、数据存储、人工审核触发等基础支撑          |

### L3：Model Runtime 层



* **支持模型**：Veo 3.1 / Sora2 / Qling / Runway / MiniMax TTS / Tunee Music

* **调用方式**：由 Adapter 层统一封装，通过 Orchestrator 调度



***

## 二、Shared Blackboard 规范

恢复并扩展 “白板发布任务” 机制，所有 Agent 按统一规则读写数据，数据结构如下：



```
{

&#x20; "project": {

&#x20;   "id": "PROJ-2025-1116-001",

&#x20;   "status": "WAITING\_FOR\_PLAN",

&#x20;   "created\_at": 1731731721

&#x20; },

&#x20; "globalSpec": {

&#x20;   "title": "Rain and Warmth",

&#x20;   "duration": 30,

&#x20;   "aspect\_ratio": "9:16",

&#x20;   "style": {

&#x20;     "tone": "warm",

&#x20;     "palette": \["#cfa66b", "#2b3a67"],

&#x20;     "visualDNA\_version": 1

&#x20;   },

&#x20;   "characters": \["C1"]

&#x20; },

&#x20; "tasks": {

&#x20;   "T001": {

&#x20;     "type": "WRITE\_SCRIPT",

&#x20;     "status": "PENDING",

&#x20;     "assigned\_to": "ScriptWriter",

&#x20;     "input": {},

&#x20;     "output": null,

&#x20;     "events": \[],

&#x20;     "lock": null,

&#x20;     "version": 1

&#x20;   }

&#x20; },

&#x20; "shots": {

&#x20;   "S01": {

&#x20;     "index": 1,

&#x20;     "status": "INIT",

&#x20;     "script": null,

&#x20;     "keyframes": \[],

&#x20;     "previewVideo": null,

&#x20;     "finalVideo": null,

&#x20;     "audio": {

&#x20;       "voice": null,

&#x20;       "music": null

&#x20;     }

&#x20;   }

&#x20; },

&#x20; "locks": {

&#x20;   "DNA\_GLOBAL": null,

&#x20;   "GLOBAL\_STYLE": null

&#x20; },

&#x20; "artifact\_index": {},

&#x20; "error\_log": \[]

}
```



***

## 三、Agent 执行流程与任务规范

### 3.1 Agent 参与流程（三步法）



1. Orchestrator 查询 pending 任务并分配给对应 Agent，任务初始状态为 `PENDING`

2. Agent 执行任务，写入输出结果至 `task.output`，并将任务状态更新为 `COMPLETED`

3. Agent 触发事件，写入 `task.events` 并通过 EventBus 广播，事件格式如下：



```
{

&#x20; "type": "SCRIPT\_WRITTEN",

&#x20; "actor": "ScriptWriter",

&#x20; "timestamp": xxxx

}
```

### 3.2 任务类型（20 类）



| 任务类别       | 具体任务类型                                                                       |
| ---------- | ---------------------------------------------------------------------------- |
| 写作类        | WRITE\_SCRIPT、REWRITE\_SCRIPT、BREAKDOWN\_SHOT、UPDATE\_SHOT\_CAMERA           |
| 图像生成类      | GENERATE\_KEYFRAME、UPSCALE\_KEYFRAME、GENERATE\_CONTROL\_MAP                  |
| 视频类        | GENERATE\_PREVIEW\_VIDEO、GENERATE\_FINAL\_VIDEO、FIX\_TEMPORAL\_INCONSISTENCY |
| 音频类        | GENERATE\_MUSIC、GENERATE\_VOICE、FIX\_LIPSYNC                                 |
| 一致性 & QA 类 | RUN\_VISUAL\_QA、RUN\_AUDIO\_QA、RUN\_CROSS\_MODAL\_QA                         |
| 修复类        | PROMPT\_TUNING、MODEL\_SWAP\_RETRY、DEGRADE\_QUALITY、HUMAN\_REVIEW\_REQUIRED   |
| 项目级类       | PLAN\_SHOTS、FINAL\_RENDER\_READY                                             |

### 3.3 任务数据格式



```
{

&#x20; "task\_id": "T011",

&#x20; "type": "GENERATE\_PREVIEW\_VIDEO",

&#x20; "shot\_id": "S01",

&#x20; "priority": 4,

&#x20; "assigned\_to": "VideoGen",

&#x20; "input": {

&#x20;   "start\_frame": "s3://project/S01/start.png",

&#x20;   "end\_frame": "s3://project/S01/end.png",

&#x20;   "model\_package": "High"

&#x20; },

&#x20; "status": "PENDING",

&#x20; "retry": 0,

&#x20; "max\_retry": 2,

&#x20; "events": \[]

}
```



***

## 四、全局时间线（细化执行步骤）

### STEP 0：用户需求解析



* 任务：T001（WRITE\_SCRIPT）

* 流程：用户输入 → Requirement Parser → 写入 GlobalSpec 至白板

### STEP 1：剧本创作



* 执行：ScriptWriter 执行 T001（WRITE\_SCRIPT）

* 事件：触发 `SCRIPT_WRITTEN` 事件，驱动 ShotDirector 执行 PLAN\_SHOTS

### STEP 2：分镜规划



* 执行：ShotDirector 执行 PLAN\_SHOTS，拆分剧本为多个 shots（如 S01、S02...）

* 输出：shots 状态设为 `INIT`，生成对应关键帧生成任务（T100：S01 关键帧、T101：S02 关键帧等）

### STEP 3：关键帧生成



* 执行：ImageGenAgent 执行 GENERATE\_KEYFRAME

* 输出：生成 start frame、end frame、control map、depth/pose，写入对应 shot 的 keyframes

* 事件：触发 `IMAGE_GENERATED` 事件

### STEP 4：视觉特征融合



* 执行：ArtDirector 接收 `IMAGE_GENERATED` 事件，执行 T200（EXTRACT\_VISUAL\_FEATURE）

* 输出：更新白板 dna\_bank（版本 + 1、角色置信度如 C1.confidence=0.93）

### STEP 5：预览视频请求



* 执行：ShotDirector 发起 T300（GENERATE\_PREVIEW\_VIDEO）

### STEP 6：预览视频生成



* 执行：VideoGenAgent 执行 T300，生成预览视频

* 输出：写入 shot 的 previewVideo

* 事件：触发 `PREVIEW_VIDEO_READY` 事件

### STEP 7：一致性 QA 校验



* 执行：ConsistencyGuardian 执行 T400（RUN\_VISUAL\_QA）、T401（RUN\_CROSS\_MODAL\_QA）

* 分支处理：


  * 校验不通过：触发 T402（PROMPT\_TUNING）或 T403（MODEL\_SWAP\_RETRY）

  * 重试仍失败：触发 T404（HUMAN\_REVIEW\_REQUIRED）

### STEP 8：Shot 审批与最终视频生成



* 前置条件：QA 校验通过，标记 shot 为 `APPROVED`

* 执行：对通过的 shot 发起 T501（GENERATE\_FINAL\_VIDEO）

### STEP 9：音频制作与校验



* 执行：同时触发 T600（GENERATE\_VOICE）、T601（GENERATE\_MUSIC）、T602（RUN\_AUDIO\_QA）

### STEP 10：最终渲染输出



* 执行：Editor 自动剪辑，输出 final render

* 事件：触发 `PROJECT_FINALIZED` 事件（项目结束）



***

## 五、Model Adapter 设计

### 5.1 架构结构



* Agent 内置多个 ModelAdapter，由 Orchestrator 统一控制

* 示例（ImageGenAgent 内部结构）：



```
ImageGenAgent/

&#x20; adapters/

&#x20;   sora\_img\_adapter.py

&#x20;   sdxl\_adapter.py

&#x20;   runaway\_adapter.py

&#x20;   qling\_adapter.py
```

### 5.2 Adapter 类定义



```
class ImageModelAdapter:

&#x20;   def generate(self, prompt, seed, params):

&#x20;       raise NotImplementedError
```

### 5.3 调用流程（解耦核心）



1. ImageGenAgent 不决定模型选择，由 Orchestrator 指定模型（如 "model": "veo-3.1" 或 "model": "qling-fast"）

2. ImageGenAgent 根据 task.input.model 字段选择对应 Adapter 执行任务，解决逻辑分支耦合问题



***

## 六、Music & Voice Agent 激活规则

### VoiceActor Agent 激活规则



```
if VideoModel.supports\_audio == false:

&#x20;   need\_voice = True

else:

&#x20;   need\_voice = user.force\_voice or project.audio.override
```

### MusicComposer Agent 激活规则



```
if user.disable\_music == True:

&#x20;   skip

if VideoModel.supports\_bgm == True:

&#x20;   skip  # 使用视频模型自带的音乐
```



***

## 七、HumanGate 触发机制

当满足以下任一条件时，自动生成 T999（HUMAN\_REVIEW\_REQUIRED）任务：



1. Agent 任务重试次数 > max\_retry

2. QA 校验结果低于 catastrophic-level

3. DNA confidence < 0.55

4. 模型返回 500/429 错误超过阈值

同时写入错误日志至白板 error\_log：



```
{

&#x20; "shot": "S02",

&#x20; "reason": "...",

&#x20; "recommendation": "Change camera movement"

}
```



***

## 八、开发核心准则

所有 Agent 与 Shared Blackboard 交互时，每个任务的生命周期由 Orchestrator 与 Blackboard 作为唯一事实源，通过 Adapter 封装实现模型调用解耦。



***

## 可选扩展生成内容

可进一步生成以下技术文档，直接用于开发落地：



* A. 完整数据库 Schema（PostgreSQL JSONB 或 MongoDB）

* B. 全部任务类型的 JSON Schema

* C. EventBus 30+ 事件定义

* D. 全套 Agent 的 Manifest API

* E. keyframe prompt、music markers、voice timestamps 规范

* F. 后端 microservice 架构设计

* G. 模型成本表 + Orchestrator 选择策略



***

要不要我帮你生成一份**完整的数据库 Schema（PostgreSQL JSONB 格式）**，方便技术团队直接用于数据库设计？

> （注：文档部分内容可能由 AI 生成）