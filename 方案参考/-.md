# Agent 团队方案（最终落地版）

本文档为 Spec-kit 风格流水线、多 agent、ModelRouter + Adapter、Living Agent Pipeline、三次微循环、Chef / 共享白板、Audio Strategy 最终落地版的 Agent 团队方案，包含完整设计、协议、消息样例、策略、容错与 MVP 内容。

## 一、核心设计概述

所有 “产出” 由职责清晰的 Agent 负责，通过 ModelRouter + Adapter 实现模型调度与适配，Agent 间通过 Shared Blackboard + Event Bus 实现协作，Audio Strategy Layer 自动决定是否允许或限制外部配音，Agent 具备自愈能力，可通过协作修正问题，最终由 Chef 把控质量。

## 二、Agent 体系（11 个 Agent + Infra）

每个 Agent 均包含输入 / 输出、能力、KPIs、失败策略，具体如下：

### 2.1 ChefAgent



* **职责**：项目策略制定、预算控制、熔断决策、人工决策入口、最终质量担保。

* **输入**：project spec、budget、QA reports。

* **输出**：project-level decisions（retry / escalate / change-model / request human）。

* **KPIs**：8 次 HumanGate 报告并提供修正建议（带成本影响）。

### 2.2 RequirementParser Agent



* **输入**：GlobalSpec（title、duration、aspect、tone、musthaves、forbidden、model preferences）。

* **输出**：GlobalSpec JSON（写入 Blackboard）。

* **KPIs**：confidence < 0.6 时，写标记并触发 HumanGate。

### 2.3 Planner Agent



* **输入**：GlobalSpec。

* **输出**：Plans（shot 列表、timeline、key events、initial style token、audio policy hint），生成 Plan.json（shots \[] 写入 Blackboard）。

* **KPIs**：plan acceptance rate。

* **失败策略**：duration 与 shots 不匹配时，自动调整并通知 ChefAgent。

### 2.4 ScriptWriter Agent



* **输入**：shot 信息。

* **输出**：Script.json（per-shot actions + voice lines + time anchors），提供 Script Visual Feasibility 评估。

* **KPIs**：分镜一致率。

* **附加能力**：为 Music/Voice 提供时间窗口与 cue。

### 2.5 ShotDirector Agent



* **输出**：shot.json（camera、duration、keyframe prompts、motion plan），触发 keyframe 生成 preview video。

* **KPIs**：preview pass rate、motion smoothness。

* **核心能力**：定义 camera language、shot-level visual hooks，决定首尾帧需求。

### 2.6 ArtDirector Agent



* **输出**：dna\_bank updates、prompt\_weight\_updates。

* **KPIs**：identity\_drift\_rate、color\_drift\_rate。

* **核心能力**：管理 DNA bank / 道具，控制 prompt weights drift。

### 2.7 PromptEngineer Agent



* **输入**：GlobalStyle + shot spec + DNA token。

* **输出**：final\_prompt、seed、control config。

* **KPIs**：prompt→artifact pass rate。

* **核心能力**：编织最终 prompt template，进行 A/B 生成并选择最优 prompt。

### 2.8 ImageGen Agent（task-level）



* **输入**：prompts。

* **输出**：keyframes、control maps、embeddings、metadata（写入 Blackboard）。

* **KPIs**：image pass rate、latency、cost\_per\_image。

* **失败策略**：fallback 到 backup model 进行 prompt retry。

* **核心能力**：通过 ModelRouter.generate\_image 获取标准化 artifact。

### 2.9 VideoGen Agent（task-level）



* **输入**：shot 信息、keyframes + prompt + control maps + audio policy clip + metadata。

* **输出**：rendered clip artifact + audio\_info（包含 audio\_quality\_score、timestamps），生成 flow maps、per-frame embeddings、audio\_track info。

* **KPIs**：render success rate、temporal\_coherence\_score、cost\_per\_sec。

* **失败策略**：质量渲染→fallback model→降级至 slideshow。

### 2.10 Music-Composer Agent



* **输入**：Script 的情绪标注与 markers。

* **输出**：track artifact、bpm、markers、music\_embedding。

* **KPIs**：music\_mood\_match\_score、iterations\_to\_accept、latency。

* **限制条件**：若 style/preset global audio policy 禁止，则不执行。

### 2.11 Voice-Actor Agent



* **输入**：旁白 / 对白文本、timestamps、word/phoneme 信息。

* **输出**：voice artifact + timestamps + voice\_embedding。

* **KPIs**：lip\_sync\_estimate、voice\_identity\_match。

* **触发条件**：VideoGen 返回 “audio-integrated” 时，结合 Audio Strategy 执行。

### 2.12 Infra Agent（基础设施）



* **核心组件**：Orchestrator（负责 locks、traceability）、Shared Blackboard + Artifact Storage（S3）、ModelRouter + Adapter（含 capability manifest）、ConsistencyGuardian（QA + HumanGate）。

## 三、Shared Blackboard - Schema

建议使用 JSON document DB（Postgres JSONB / Mongo），搭配 Redis 缓存，必须记录版本和锁。

### 示例 Schema



```
{

"project\_id":"PROJ-20251116-001",

"status":"SHOT\_PLANNING",

"globalSpec": { "...": "..." },

"plan": {

"shots": {

"S01": { "status":"PENDING", "camera":"50mm", "duration":4.0 }

}

},

"dna\_bank": {

"C1": { "embedding": "...", "version": 3, "conf": 0.92 }

},

"artifacts": {

"S01\_start.png": { "url":"s3://...", "seed":1234, "model":"sdxl-1.0", "uses":2 }

},

"budget":{"total":100,"used":23.5},

"locks": { "globalStyle":"v4" },

"error\_log":\[]

}
```

## 四、Event Bus（事件总线）

### 4.1 重要事件示例

事件必须包含 project\_id、actor、causation\_id、payload\_pointer，关键事件包括：

PROJECT\_CREATED、SCENE\_WRITTEN、SHOT\_PLANNED、KEYFRAME\_REQUESTED、IMAGE\_GENERATED、PREVIEW\_VIDEO\_REQUESTED、PREVIEW\_VIDEO\_READY、MUSIC\_REQUESTED、MUSIC\_COMPOSED、VOICE\_REQUESTED、VOICE\_RENDERED、VIDEO\_RENDER\_REQUESTED、VIDEO\_RENDERED、QA\_REPORT、CONSISTENCY\_FAILED、RETRY\_REQUESTED、CHEF\_ESCALATE、HUMAN\_APPROVAL。

### 4.2 事件总线原则



* Agent 不直接调用另一个 Agent，通过订阅事件实现交互。

* Agent 处理事件时必须写回 Blackboard pointer。

* 使用 causation\_id 做链路追踪。

## 五、ModelRouter + Adapter + AudioIntegrated 配置

### 5.1 Capability Manifest（能力清单）



```
{

"name":"sora2",

"capabilities":\["text2video","frames2video","integrated\_audio","lip\_sync"],

"audio\_integrated": true,

"audio\_quality": "high",

"cost\_per\_sec": 0.50,

"max\_duration\_sec": 30,

"aspect\_ratios":\["9:16","16:9"]

}
```

> 说明：audio_integrated: true 是关键标识，表示该模型自带高质量音轨且口型 / 音轨与画面高度绑定，应禁用外部 Voice/Music Agent 的主导合成行为。

### 5.2 ModelRouter（模型路由）



* 接收 generate\_video (request) 和 manifest 信息。

* 若 audio\_integrated == true → 标记 clip.audio\_policy = model\_embedded，返回结果并写入 Blackboard AudioStrategy decision。

* 若 audio\_integrated == false → clip.audio\_policy = external\_allowed，触发 Voice/Music Agents 执行。

* 负责调用相应 Adapter（SoraAdapter、VeoAdapter、TuneeAdapter、MiniMaxAdapter 等），将原始数据转为 normalized schema 后返回上层 Agent。

### 5.3 Adapter 输出统一 Schema（视频产物示例）



```
{

"artifact\_url":"s3://.../shot\_S01.mp4",

"duration":4.0,

"resolution":"1080x1920",

"model\_version":"sora2-v2.0",

"audio\_info":{

"present": true,

"audio\_integrated": true,

"audio\_quality\_score": 0.92,

"has\_speech": true,

"speech\_text": "She was alone...",

"speech\_alignment\_score": 0.95

},

"diagnostics": {...}

}
```

### 5.4 Adapter 核心接口

所有 Adapter 需实现以下接口，输出包含 artifact\_url、duration、format、sampling\_rate、model\_version、metadata、diagnostics、cost 等信息：



* generate\_image(prompt, control=None, max\_images=1) → standardized\_image\_result

* generate\_video(request\_payload) → standardized\_video\_result

* generate\_voice(text, voice\_token, options) → standardized\_voice\_result

* compose\_music(prompt, duration, style) → standardized\_music\_result

## 六、Audio Strategy Layer（音频策略层）

### 6.1 核心作用

VideoGen 请求 / 完成后，以及在 Plan 阶段，决定 Music/Voice Agent 的执行模式（full\_replace /overlay\_low/disallow）。

### 6.2 策略等级（示例）



* MODEL\_EMBEDDED：video.model.audio\_integrated == true → 默认 disable\_full\_audio\_replace，允许 overlay\_low\_volume\_bgm 或 post\_mix\_reverb。

* EXTERNAL\_ALLOWED：video.model.audio\_integrated == false → 允许 full\_audio\_agents\_enabled（Voice + Music）。

* USER\_OVERRIDE：explicit force\_audio\_replace → 允许但提示风险，需 ChefAgent 确认。

### 6.3 决策伪代码



```
def audio\_policy\_decision(project, shot):

&#x20;   model = shot\['render\_request']\['model']

&#x20;   manifest = ModelRouter.get\_manifest(model)

&#x20;   if manifest\['audio\_integrated']:

&#x20;       if project\['user\_options'].get('force\_audio\_override'):

&#x20;           return { "mode":"overlay\_low", "note":"user forced override; lip\_sync risk" }

&#x20;       else:

&#x20;           return { "mode":"disable\_external\_audio", "reason":"model\_embedded" }

&#x20;   else:

&#x20;       return { "mode":"enable\_external\_audio" }
```

### 6.4 UI / UX 表示

当用户选择 Sora2 / Veo3.1 等自带音频的模型时，默认隐藏 “配音 / BGM 替换” 选项，提供 “force override” 按钮并显示风险提示 + cost delta（成本变化）。

## 七、三次微循环（质量控制循环）

### 7.1 微循环 1：Script Visual Feasibility（脚本视觉可行性验证）



1. ScriptWriter 写 scene → 发布 SCENE\_WRITTEN 事件。

2. ShotDirector 请求 KEYFRAME\_REQUESTED，调用 low-cost model。

3. ImageGen Agent 生成图像 → 发布 IMAGE\_GENERATED 事件。

4. ArtDirector 提取 features 更新 DNA → 若不合逻辑触发 REWRITE\_SCENE 或人工介入。

### 7.2 微循环 2：Shot Previsual / Motion Preview（镜头预演 / 运动预览）



1. ShotDirector 发布 PREVIEW\_VIDEO\_REQUEST（256px，3s）。

2. VideoGen Agent 使用 cheap model 生成预览 → 发布 PREVIEW\_VIDEO\_READY 事件。

3. ConsistencyGuardian 检查 motion smoothness → 若失败则切换 shot plan（如调整镜头速度）。

### 7.3 微循环 3：Final Render Decision + Audio Strategy（最终渲染决策 + 音频策略）



1. 基于 Plan+User preference，Orchestrator 通过 ModelRouter 选择 final model。

2. 若 model 是 audio\_integrated → 设置 shot.audio\_policy = MODEL\_EMBEDDED，跳过 Voice/Music 生成（或仅叠加 BGM）。

3. 若 model 非 audio\_integrated → 按 shot 执行 Music-Composer + Voice-Actor（带 markers & timestamps），由 Editor 完成最终同步与混合。

4. ConsistencyGuardian 执行跨模态 QA → 验证通过后，ChefAgent 最终签字确认；失败则升级处理。

## 八、一致性 / QA + 自动修复

### 8.1 自动检查项（ConsistencyGuardian 执行）

#### 视觉一致性



* CLIP similarity to globalRef ≥ 0.30 → pass

* Face identity cosine ≥ 0.75 → pass

#### 时间连贯性



* Optical flow smoothness ≥ 0.85 → pass

#### 音频一致性



* 若 audio\_integrated：speech\_alignment\_score ≥ 0.85 → pass

* 若 external audio：lip\_sync\_estimate ≥ 0.80；music\_mood\_match ≥ 0.70 → pass

#### 跨模态一致性



* frame @ t embedding 与 audio @ t embedding similarity ≥ 0.25 → pass

### 8.2 自动修复策略（优先级）



1. PromptEngineer 调整 prompt weights + 重新运行 image/video（N1 = 2 次尝试）。

2. 若预算允许，切换模型（cheap → premium）（N2 = 1 次尝试）。

3. 若低成本无法修复，将镜头降级为 slideshow/short motion + 带水印预览。

4. 升级至 ChefAgent / HumanGate（最后手段）。

## 九、ChefAgent 熔断机制

三层熔断策略：



1. Level 1：Agent 自行调整 prompt。

2. Level 2：ArtDirector 更新 DNA + ScriptWriter 重新编写内容。

3. Level 3：ChefAgent 介入，允许人工录音、改变 shot 方案、退款或重做。

> 说明：所有 model 调用均记录（prompt、seed、model_version、cost），存入 artifact metadata 以便复现与审计。

## 十、典型案例

### 10.1 案例 A：Sora2（audio\_integrated=true）



1. User → RequirementParser → Planner → ScriptWriter → ShotDirector。

2. ShotDirector 触发 KEYFRAME\_REQUESTED → ImageGen（low-cost）→ 预览验证通过。

3. 最终渲染：VideoGenAgent 使用 Sora2 模型 → 返回 clip（audio\_integrated=true + audio\_info.speech\_text）。

4. AudioStrategy → disable\_external\_audio（除非用户强制覆盖）。

5. Editor 仅可叠加低音量 BGM（Music-Composer 生成音轨，Editor 进行轻量混合）。

6. ConsistencyGuardian 验证（语音对齐通过）→ 最终交付。

### 10.2 案例 B：Runway/Pika（external audio allowed）



1. 执行 Plan 阶段所有步骤。

2. VideoGenAgent 渲染（无集成音频）→ clip.audio\_info.present=false。

3. MusicComposer 按 shot 生成音轨（基于 markers）；VoiceActor 生成带 timestamps 的语音。

4. Editor 对齐语音（音素时间戳→帧）并混合音乐音轨（markers→剪辑点）。

5. ConsistencyGuardian 检查口型同步与情绪匹配 → 验证通过后最终交付。

## 十一、ModelRouter JSON/YAML + Adapter 配置



```
model\_router:

&#x20; voice:

&#x20;   minimax:

&#x20;     api\_adapter: adapters/voice/minimax\_adapter.py

&#x20;     capability:

&#x20;       audio\_integrated: false

&#x20;       languages: \["zh","en"]

&#x20;       voice\_clone: true

&#x20;       cost\_per\_char: 0.0008

&#x20;   elevenlabs:

&#x20;     api\_adapter: adapters/voice/elevenlabs\_adapter.py

&#x20;     capability:

&#x20;       audio\_integrated: false

&#x20;       languages: \["en"]

&#x20;       voice\_clone: true

&#x20;       cost\_per\_char: 0.002

&#x20; music:

&#x20;   tunee:

&#x20;     api\_adapter: adapters/music/tunee\_adapter.py

&#x20;     capability:

&#x20;       cost\_per\_sec: 0.02

&#x20;       style\_presets: \["ambient","epic","suspense"]

&#x20;   suno\_v4:

&#x20;     api\_adapter: adapters/music/suno\_adapter.py

&#x20;     capability:

&#x20;       cost\_per\_sec: 0.12

&#x20; video:

&#x20;   sora2:

&#x20;     api\_adapter: adapters/video/sora2\_adapter.py

&#x20;     capability:

&#x20;       audio\_integrated: true

&#x20;       audio\_quality: high

&#x20;       cost\_per\_sec: 0.5

&#x20;   veo3\_1:

&#x20;     api\_adapter: adapters/video/veo\_adapter.py

&#x20;     capability:

&#x20;       audio\_integrated: true

&#x20;       audio\_quality: high

&#x20;       cost\_per\_sec: 0.45

&#x20;   runway:

&#x20;     api\_adapter: adapters/video/runway\_adapter.py

&#x20;     capability:

&#x20;       audio\_integrated: false

&#x20;       cost\_per\_sec: 0.08
```

## 十二、指标 / KPI 与监控建议

### 12.1 核心监控指标



* 渲染效率：avg\_render\_time\_per\_shot、render\_success\_rate。

* 成本控制：cost\_per\_project、cost\_per\_second。

* 质量指标：auto\_pass\_rate、human\_intervention\_rate、identity\_drift\_rate、lip\_sync\_score\_avg。

* 系统稳定性：adapter\_error\_rate、retry\_rate、fallback\_rate。

* UX 体验：time\_user\_input\_to\_preview（MVP 预览目标 < 5 min）。

## 十三、MVP 规划

### 13.1 阶段 1（4 周）



* 搭建 Orchestrator + Shared Blackboard + Event Bus。

* 实现核心流水线 Agent：RequirementParser、Planner、ScriptWriter、ShotDirector、PromptEngineer。

* 实现 ModelRouter + 2 个 Adapter：Image（SDXL）+ Video（Runway cheap model）。

* 实现 Image preview loop + ArtDirector 基础 DNA 功能。

* 开发基础 UI：用于查看关键帧、进度及 Chef 通知。

### 13.2 阶段 2（4-8 周）



* 新增 VideoGen 与 Sora2（或 Veo3.1）集成，标记 audio\_integrated 属性。

* 实现 MusicComposer（Tunee）+ VoiceActor（MiniMax）Adapters + Editor 基础混合功能。

* 实现 ConsistencyGuardian 及 QA 阈值 + 自动重试 / 降级策略。

* 开发 HumanGate UI 及成本估算功能。

## 十四、交付物（可直接生成）



* Agent Manifest JSON

* Shared Blackboard JSON Schema

* Event Catalog

* ModelRouter YAML config

* 端到端跟踪示例（Sora2 & Runway）：JSON event trace

要不要我帮你将这份 Markdown 文档导出为独立的**MD 文件**，方便你直接保存和使用？

> （注：文档部分内容可能由 AI 生成）