# 用户审批功能优化说明

## 优化背景

根据用户反馈，系统需要在关键阶段（如剧本生成、分镜规划等）暂停并等待用户审查确认，确保生成内容符合用户预期。

## 新增功能

### 1. 用户审批检查点机制

**默认审批阶段**:
- **剧本生成** (SCENE_WRITTEN): 用户审查剧本文本和分镜描述
- **分镜规划** (SHOT_PLANNED): 用户确认镜头设计和运镜方案
- **关键帧预览** (KEYFRAME_GENERATED): 用户查看关键帧图片
- **预览视频** (PREVIEW_VIDEO_READY): 用户确认运动效果和时间连贯性
- **最终视频** (FINAL_VIDEO_READY): 用户最终确认成品

### 2. 用户决策选项

每个审批检查点支持三种决策：

1. **批准 (Approve)**
   - 用户满意当前结果
   - 系统继续执行下一阶段
   - 记录审批通过

2. **修改 (Revise)**
   - 用户提供具体修改意见
   - Agent 基于意见重新生成
   - 再次提交审批
   - 支持多轮修改

3. **拒绝 (Reject)**
   - 用户完全不满意
   - Agent 从头重新生成
   - 不保留任何中间结果

### 3. 审批模式

**手动模式（默认）**:
- 在所有默认检查点暂停
- 等待用户审批后继续
- 适合对质量要求高的项目

**自动模式**:
- 跳过所有审批检查点
- 直接执行到项目完成
- 适合快速生成或测试

**自定义模式**:
- 用户选择需要审批的检查点
- 例如：只审批剧本和最终视频
- 灵活平衡质量和效率

## 技术实现

### 1. 新增数据模型

```typescript
interface ApprovalRequest {
  approval_id: string;
  project_id: string;
  stage: ApprovalStage;  // 审批阶段
  status: ApprovalStatus;  // 审批状态
  
  content: {
    type: "script" | "shots" | "keyframes" | "preview_video" | "final_video";
    data: any;  // 具体内容
    preview_url?: string;  // 预览链接
  };
  
  user_decision?: {
    decision: "approve" | "revise" | "reject";
    revision_notes?: string;  // 修改意见
    decided_at: string;
  };
  
  created_at: string;
  timeout_minutes: number;  // 超时时间
}
```

### 2. 新增事件类型

- **USER_APPROVAL_REQUIRED**: Agent 请求用户审批
- **USER_APPROVED**: 用户批准继续
- **USER_REVISION_REQUESTED**: 用户请求修改
- **USER_REJECTED**: 用户拒绝重做

### 3. Orchestrator 增强

```python
def check_approval_required(self, event):
    """检查是否需要用户审批"""
    # 检查项目配置
    # 检查审批检查点设置
    # 返回是否需要审批

def request_user_approval(self, event):
    """请求用户审批"""
    # 创建审批请求
    # 发布 USER_APPROVAL_REQUIRED 事件
    # 暂停项目执行

def handle_user_decision(self, decision_event):
    """处理用户决策"""
    # 根据决策类型执行相应操作
    # approve: 恢复项目
    # revise: 创建修改任务
    # reject: 创建重做任务
```

### 4. Agent 修改处理能力

每个关键 Agent 新增修改处理方法：

```python
# ScriptWriter Agent
def handle_user_revision(self, revision_request):
    """处理用户对剧本的修改意见"""
    original_script = self.get_original_script()
    revision_notes = revision_request.revision_notes
    
    # 基于用户意见修改剧本
    revised_script = self.llm_revise_script(
        original_script,
        revision_notes
    )
    
    # 更新并重新提交审批
    return revised_script
```

## UI 设计

### 1. 审批通知

- 实时弹窗通知用户有新的审批请求
- 显示审批阶段和内容类型
- 提供快速预览入口

### 2. 审批界面

**剧本审批**:
- 显示完整剧本文本
- 显示分镜列表
- 提供修改意见输入框
- 批准/修改/拒绝按钮

**图片/视频审批**:
- 大图/视频播放器
- 显示相关元数据（分辨率、时长等）
- 提供修改意见输入框
- 批准/修改/拒绝按钮

### 3. 审批历史

- 显示所有审批记录
- 显示每次决策和修改意见
- 支持查看历史版本对比

### 4. 模式切换

- 项目创建时选择审批模式
- 支持运行中切换模式
- 自定义检查点选择界面

## 工作流程示例

### 场景：用户对剧本不满意

```
1. ScriptWriter 生成剧本
   ↓
2. 发布 SCENE_WRITTEN 事件
   ↓
3. Orchestrator 检测到需要审批
   ↓
4. 创建 ApprovalRequest
   ↓
5. 发布 USER_APPROVAL_REQUIRED 事件
   ↓
6. UI 通知用户审批
   ↓
7. 用户查看剧本，选择"修改"
   ↓
8. 用户输入："请增加更多情感描写，减少动作场景"
   ↓
9. 发布 USER_REVISION_REQUESTED 事件
   ↓
10. Orchestrator 创建修改任务
    ↓
11. ScriptWriter 基于意见重新生成
    ↓
12. 再次提交审批
    ↓
13. 用户满意，选择"批准"
    ↓
14. 系统继续执行下一阶段
```

## 配置示例

### 项目创建时配置

```json
{
  "globalSpec": {
    "user_options": {
      "auto_mode": false,  // 手动模式
      "approval_checkpoints": [
        "SCENE_WRITTEN",
        "PREVIEW_VIDEO_READY",
        "FINAL_VIDEO_READY"
      ],
      "approval_timeout_minutes": 60
    }
  }
}
```

### 自动模式配置

```json
{
  "globalSpec": {
    "user_options": {
      "auto_mode": true  // 跳过所有审批
    }
  }
}
```

## 实施任务

已在 `tasks.md` 中新增 Phase 6 的 4 个任务：

- **任务 25**: 实现用户审批机制
- **任务 26**: 实现 Agent 审批处理能力
- **任务 27**: 实现审批 UI
- **任务 28**: 实现自动模式切换

**预计工期**: 3 周

## 影响评估

### 对现有设计的影响

1. **Orchestrator**: 新增审批流程控制逻辑
2. **Event Bus**: 新增 4 个审批相关事件
3. **Blackboard**: 新增 approval_requests 和 approval_history 字段
4. **Agent**: 核心 Agent 需新增修改处理方法
5. **UI**: 新增审批界面和通知功能

### 对工期的影响

- 原 MVP 工期：19 周
- 新增审批功能：1 周
- **新 MVP 工期：20 周（约 5 个月）**

### 对用户体验的影响

**优点**:
- ✅ 用户可控制生成质量
- ✅ 避免浪费成本在不满意的内容上
- ✅ 支持迭代优化
- ✅ 灵活的模式切换

**注意事项**:
- ⚠️ 手动模式会增加总生成时间
- ⚠️ 需要用户及时响应审批请求
- ⚠️ 多次修改会增加成本

## 最佳实践建议

1. **首次使用**: 建议使用手动模式，熟悉系统能力
2. **快速测试**: 使用自动模式快速验证想法
3. **正式项目**: 使用自定义模式，只审批关键阶段
4. **成本控制**: 在剧本阶段仔细审批，避免后期大改
5. **及时响应**: 设置审批提醒，避免超时

## 文档更新

已更新以下文档：

1. **requirements.md**: 新增 Requirement 11（用户审批检查点）
2. **design.md**: 
   - 新增审批相关事件
   - 扩展 Orchestrator 设计
   - 新增 ApprovalRequest 数据模型
   - 更新系统流程图
3. **tasks.md**: 新增 Phase 6 的 4 个实施任务
4. **LivingAgentPipeline_v2_Unified_Design.md**: 更新核心优化和 MVP 规划

---

**优化完成日期**: 2025-11-16  
**文档版本**: v2.1
